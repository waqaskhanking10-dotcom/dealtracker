window.aui.amd_define("@amzn/webflow-js",["exports","@amzn/kata-web-framework-external-config","@amzn/kata-web-framework-external-composed","@amzn/webflow-js-register-view-model-mapper","@amzn/kata-web-framework-rxjs-adapter","@amzn/webflow-rx","@amzn/kata-web-framework-patch"],function(exports,kataWebFrameworkExternalConfig,kataWebFrameworkExternalComposed,webflowJsRegisterViewModelMapper,kataWebFrameworkRxjsAdapter,webflowRx,Patch){"use strict";function _interopNamespaceDefault(t){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const r in t)if(r!=="default"){const n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:()=>t[r]})}}return e.default=t,Object.freeze(e)}const Patch__namespace=_interopNamespaceDefault(Patch);function registerPortableFunction(t,e){functionRegistry.registerFunction(t,e)}function executePortableFunction(t,e){return functionRegistry.invokeFunction(t,e)}const urlParameterKeys=["WebFlowJsUrlParameters","pageHostOverride","showInsight","tinkerId","auiDebug"],debugParameterKeys=["showInsight"];function isDebug(){if(isLocalhost()||isWebFlowPreview())return!0;const t=new URLSearchParams(window.location.search);for(const e of debugParameterKeys)if(t.has(e))return!0;return!1}function isWebFlowPreview(){return window.location.href.includes("webflow-preview")}function isLocalhost(){return window.location.href.includes("localhost")}const logToConsole=(...t)=>{isDebug()&&console.log(...t)},warnToConsole=(...t)=>{isDebug()&&console.warn(...t)},errorToConsole=(t,e)=>{isDebug()&&console.error(t,e)},log$1=(t,e,r)=>{if(window.ueLogError){const n=r||new Error(e);window.ueLogError(n,{logLevel:t,attribution:"webflow_js",message:"WebFlowJS: "+e}),errorToConsole(e,n)}},logError=(t,e)=>log$1("ERROR",t,e),logFatal=(t,e)=>log$1("FATAL",t,e);let onDismiss;const showUpdatableToast=({messages:t,toastPosition:e})=>{t.subscribe(r=>{var a,s,c,u;logToConsole(`showToast: ${r}`);const n=document.createElement("div");n.id="toast",n.style.position="fixed",n.style.bottom=((a=e==null?void 0:e.web)==null?void 0:a.bottom)??"75px",n.style.left=((s=e==null?void 0:e.web)==null?void 0:s.left)??"50%",n.style.right=((c=e==null?void 0:e.web)==null?void 0:c.right)??"auto",n.style.top=((u=e==null?void 0:e.web)==null?void 0:u.top)??"auto",n.style.transform="translateX(-50%)",n.style.display="flex",n.style.width="100%",n.style.flexDirection="row",n.style.alignItems="center",n.style.zIndex="9999",n.style.alignSelf="center",n.style.justifyContent="center",n.style.padding="16px",n.style.backgroundColor="#0F1111",n.style.borderRadius="8px",onDismiss==null||onDismiss(),onDismiss=()=>{n.remove(),onDismiss=void 0};const o=document.createElement("span");o.textContent=r,o.style.textAlign="left",o.style.lineHeight="20px",o.style.flex="6",o.style.fontSize="16",o.style.fontWeight="400",o.style.color="#FFFFFF",n.appendChild(o),document.body.appendChild(n),setTimeout(()=>{n&&n.remove()},2400)})},BOTTOM_CONTENT="<p style='height:100vh;'></p>",getModalStyles=t=>`
    background-color: white;
    color: black;
    padding: 25px;
    height: ${t}px;
    position: fixed;
    width: 100vw;
    bottom: 0;
`,getWrapper=(t,e)=>`
    <div id="${t}" style="${getModalStyles(e)}"></div>
`,showPriceInfo=({rawInfoText:t})=>{logToConsole(`showPriceInfo: ${t}`),(window.top||window).P.when("a-modal-framework","a-sheet").execute("show-price-info",function(r,n){var i;const o="a-modal-showPriceInfo",a={name:"showPriceInfoModal"},s=((i=n.get("webflow-bottomsheet-instance"))==null?void 0:i._height)||600,c=getWrapper(o,s),u={type:"inline",source:t+BOTTOM_CONTENT};new r(c,u,a).present()})},endpoint="/webflow-rx/",mockRxEndpoint="http://localhost:8080",internalDataStoredValues={requestType:"cart.add-items.request/v1",resourcePath:"items/v1",responseType:"cart.add-items/v1",method:"POST",callbackId:"your-saves-immersive-view-experience/Mon Aug 07 2023 13:36:46 GMT-0700 (Pacific Daylight Time)/919866f55af84162a94a6928be5b040636954948bb80db9cc3fe96fbab901b2a"};class WebFlowClient{async callbackToWebFlowServer(e){const r=this.constructUrl(e);return fetch(r,this.buildRequest(e)).then(n=>n).catch(n=>(logFatal("Something went wrong with the fetch call: "+n.message,n),{}))}buildRequest(e){return{headers:this.buildHeaders(),method:e.method,body:JSON.stringify(e)}}buildHeaders(){const e={Accept:"application/vnd.com.amazon.xa+json"},r=document.querySelector('meta[name="flow-closure-id"]');if(r){const n=r.getAttribute("content");n&&(e["x-amzn-flow-closure-id"]=n)}return e}constructUrl(e){const r=new URLSearchParams(window.location.search);if(r.has("webflowrxMockResponse"))return new URL(`${mockRxEndpoint}?mock-response=${r.get("webflowrxMockResponse")}`);const n=new URLSearchParams;r.forEach((u,l)=>{urlParameterKeys.some(i=>i.toLowerCase()===l.toLowerCase())&&n.set(l,u)});const o=e.flowRoute,a=this.getServerEndpoint().toString()+((o==null?void 0:o.flow.experienceId)??"");o!=null&&o.flow.inputs&&Object.entries(o.flow.inputs).forEach(([u,l])=>{if(l!=="placeholder"){const p=typeof l=="object"&&l!==null?JSON.stringify(l):String(l);n.set(u,p)}});const s=n.toString(),c=s?"?"+s+"&":"";return new URL(a+c)}getUrlParameters(e){let r="";return urlParameterKeys.forEach(n=>{const o=e.get(n);o!=null&&(r+=n+"="+o+"&")}),r!=""?"?"+r:r}getServerEndpoint(){if(location.hostname.includes("amazon")){const e=new URL(location.origin);return e.pathname=endpoint,e}return new URL("https://pre-prod.amazon.com"+endpoint)}}var StateChannel=(t=>(t[t.AmazonApi=0]="AmazonApi",t[t.Test=1]="Test",t))(StateChannel||{}),CollisionResolutionStrategy=(t=>(t[t.Override=0]="Override",t[t.Skip=1]="Skip",t[t.ReplaceEntirely=2]="ReplaceEntirely",t))(CollisionResolutionStrategy||{});const _StateManager=class F{constructor(){if(F.instance)throw new Error("State manager is a singlaton class that should not be initialized more than once");this.clientSideStates=new Map,this.nodeStates=new Map}static getInstance(){return F.instance||(F.instance=new F),F.instance}postState(e,r,n,o){let a=this.clientSideStates.get(e);a||(a={}),a[r]=this.updatedState(a[r]??{},n,o),this.clientSideStates.set(e,a)}updatedState(e,r,n){if(n===0)return this.deepOverrideState(e,r);throw new Error("Unsupported collisionResolutionStrategy="+n)}updatedStateV2(e,r,n){if(n===0)return this.deepOverrideStateV2(e,r);throw new Error("Unsupported collisionResolutionStrategy="+n)}deepOverrideState(e,r){const n={...e};for(const o in r)typeof r[o]=="object"&&r[o]!==null&&typeof n[o]=="object"&&n[o]!==null?n[o]=this.deepOverrideState(n[o],r[o]):n[o]=r[o];return n}deepOverrideStateV2(e,r){const n={...e};for(const o in r)typeof r[o]=="object"&&r[o]!==null&&typeof n[o]=="object"&&n[o]!==null?Array.isArray(r[o])||Array.isArray(n[o])?n[o]=r[o]:n[o]=this.deepOverrideStateV2(n[o],r[o]):n[o]=r[o];return n}getState(e,r){const n=this.clientSideStates.get(e);if(n&&n[r]!==void 0)return n[r]}saveNodeState(e){this.nodeStates.set(e.id,e.state)}deleteNodeState(e){this.nodeStates.delete(e)}getNodeStates(){const e=[];return this.nodeStates.forEach((r,n)=>{e.push({id:n,state:r})}),e}getStateByVmmId(e,r,n){const o=`resource_${n}_vmmId_${r}`,a=this.clientSideStates.get(e);if(a&&a[o]!==void 0)return a[o]}postStateByVmmId(e,r,n,o,a){const s=`resource_${n}_vmmId_${r}`;let c=this.clientSideStates.get(e);c||(c={}),c[s]=this.updatedStateV2(c[s]??{},o,a),this.clientSideStates.set(e,c)}};_StateManager.instance=null;let StateManager=_StateManager;class InitialRenderStateManager{static saveInitialRenderingStateV1(e,r){this.saveAapiResourceReferencesV1(e.aapiResourceReferences,r)}static saveAapiResourceReferencesV1(e,r){try{JSON.parse(e).references.forEach(o=>{const a={resourcePath:o.resource,entity:o.entity};this.stateManager.postState(StateChannel.AmazonApi,a.resourcePath,a,CollisionResolutionStrategy.Override),r&&this.stateManager.postStateByVmmId(StateChannel.AmazonApi,r,a.resourcePath,a,CollisionResolutionStrategy.Override)})}catch(n){throw new Error(`Unable to parse and save aapi state to client side.
            Input=${e}.
            Error message=${n.message}`)}}static saveNodeState(e){this.stateManager.saveNodeState(e)}}InitialRenderStateManager.stateManager=StateManager.getInstance();const _ViewModelMapperTracker=class v{constructor(){this.completedCount=0,this.completionSubject=new webflowRx.Subject,this.expectedCount=null,this.pollingInterval=null,this.startPolling()}static getInstance(){return v.instance||(v.instance=new v),v.instance}startPolling(){this.pollingInterval=setInterval(()=>{if(this.expectedCount===null){const e=document.querySelector("[data-webflow-rx-card-count]"),r=e==null?void 0:e.getAttribute("data-webflow-rx-card-count");r&&(this.expectedCount=parseInt(r,10),this.checkCompletion(),this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null))}},100),setTimeout(()=>{this.pollingInterval&&(logError("WebFlowJS: Polling timeout - expected VMM count not found after 5 seconds"),clearInterval(this.pollingInterval),this.pollingInterval=null)},5e3)}markVMMComplete(){this.completedCount++,this.checkCompletion()}checkCompletion(){this.expectedCount!==null&&this.completedCount>=this.expectedCount&&this.completionSubject.next(!0)}resetRenderComplete(){this.completedCount=0,this.expectedCount=null,this.completionSubject=new webflowRx.Subject}getCompletionObservable(){return webflowRx.merge(webflowRx.of(!1),this.completionSubject.asObservable())}setExpectedCount(e){this.expectedCount=e,this.checkCompletion()}};_ViewModelMapperTracker.instance=null;let ViewModelMapperTracker=_ViewModelMapperTracker;const flowExperienceRenderComplete=()=>ViewModelMapperTracker.getInstance().getCompletionObservable();function extractCurrentViewModel(t){if(!t||typeof t!="object")return t;const e={};for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const n=t[r];typeof n!="function"&&(n&&typeof n=="object"&&n.__v_isRef?e[r]=n.value:e[r]=n)}return e}function invokeKWFExternalConfig(t,e){kataWebFrameworkExternalConfig.onExternalConfig("webflow",r=>{Array.isArray(r)?onExternalConfigEventBatchHandler(r,e):onExternalConfigEventLegacySingleRootEvent(r,t)})}function onExternalConfigEventBatchHandler(t,e){t.forEach(r=>{switch(logToConsole("external config data: ",r),r.type){case"view-model-mapper":{(async()=>{const n=ViewModelMapperTracker.getInstance();try{InitialRenderStateManager.saveInitialRenderingStateV1(r.metadata,r.viewModelMapperUuid);const o=kataWebFrameworkRxjsAdapter.createRxAdapterScope(),a=await webflowJsRegisterViewModelMapper.executeViewModelMapper(r.viewModelMapperUuid,r.metadata),s=await o.externalComposed(r.externalComposedKey,a,{handleReentrantRender:async()=>{const c=extractCurrentViewModel(a);await e(r,s,c)}})}catch(o){logError("WebFlow view model mapper execution failed. Event="+JSON.stringify(r),o)}finally{n.markVMMComplete()}})();break}case"node-state":{InitialRenderStateManager.saveNodeState({id:r.id,state:r.state});break}case"example":{logToConsole("WebFlow example event");break}}})}function onExternalConfigEventLegacySingleRootEvent(t,e){kataWebFrameworkExternalComposed.externalComposed(t.cardRuntimeInstanceId,{[t.publisherFunction]:r=>e(t.cardRuntimeBundleURI,r)}),logToConsole("external config data: ",t)}class WebFlowServerRxResponse{constructor(e){this.type=e}}var RxResponseType=(t=>(t.ViewPublisherResponse="ViewPublisherResponse",t.CardRerenderResponse="CardRerenderResponse",t.RemoteViewModelMapperExecutionResponse="RemoteViewModelMapperExecutionResponse",t.RemoteAAPIBatchOperationResponse="RemoteAAPIBatchOperationResponse",t.RemoteAAPIOperationResponse="RemoteAAPIOperationResponse",t.LayoutDiffingResponse="LayoutDiffingResponse",t.UnknownResponse="UnknownResponse",t))(RxResponseType||{});class UnknownRxResponse extends WebFlowServerRxResponse{constructor(e){super(RxResponseType.UnknownResponse),this.payload=e}}function _callSuper(t,e,r){return e=_getPrototypeOf(e),_possibleConstructorReturn(t,_isNativeReflectConstruct()?Reflect.construct(e,r||[],_getPrototypeOf(t).constructor):e.apply(t,r))}function _construct(t,e,r){if(_isNativeReflectConstruct())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,e);var o=new(t.bind.apply(t,n));return r&&_setPrototypeOf(o,r.prototype),o}function _isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(_isNativeReflectConstruct=function(){return!!t})()}function _toPrimitive(t,e){if(typeof t!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var n=r.call(t,e||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return typeof e=="symbol"?e:String(e)}function _typeof(t){"@babel/helpers - typeof";return _typeof=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _inherits(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(r){return r.__proto__||Object.getPrototypeOf(r)},_getPrototypeOf(t)}function _setPrototypeOf(t,e){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,o){return n.__proto__=o,n},_setPrototypeOf(t,e)}function _isNativeFunction(t){try{return Function.toString.call(t).indexOf("[native code]")!==-1}catch{return typeof t=="function"}}function _wrapNativeSuper(t){var e=typeof Map=="function"?new Map:void 0;return _wrapNativeSuper=function(n){if(n===null||!_isNativeFunction(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(n))return e.get(n);e.set(n,o)}function o(){return _construct(n,arguments,_getPrototypeOf(this).constructor)}return o.prototype=Object.create(n.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(o,n)},_wrapNativeSuper(t)}function _assertThisInitialized(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _possibleConstructorReturn(t,e){if(e&&(typeof e=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _iterableToArray(t){if(typeof Symbol<"u"&&t[Symbol.iterator]!=null||t["@@iterator"]!=null)return Array.from(t)}function _unsupportedIterableToArray(t,e){if(t){if(typeof t=="string")return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);if(r==="Object"&&t.constructor&&(r=t.constructor.name),r==="Map"||r==="Set")return Array.from(t);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _arrayLikeToArray(t,e)}}function _arrayLikeToArray(t,e){(e==null||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _nonIterableSpread(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function _createForOfIteratorHelper(t,e){var r=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&typeof t.length=="number"){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(u){throw u},f:o}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,s=!1,c;return{s:function(){r=r.call(t)},n:function(){var u=r.next();return a=u.done,u},e:function(u){s=!0,c=u},f:function(){try{!a&&r.return!=null&&r.return()}finally{if(s)throw c}}}}var hasOwnProp=Object.prototype.hasOwnProperty;function push(t,e){return t=t.slice(),t.push(e),t}function unshift(t,e){return e=e.slice(),e.unshift(t),e}var NewError=function(t){_inherits(e,t);function e(r){var n;return _classCallCheck(this,e),n=_callSuper(this,e,['JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)']),n.avoidNew=!0,n.value=r,n.name="NewError",n}return _createClass(e)}(_wrapNativeSuper(Error));function JSONPath(t,e,r,n,o){if(!(this instanceof JSONPath))try{return new JSONPath(t,e,r,n,o)}catch(u){if(!u.avoidNew)throw u;return u.value}typeof t=="string"&&(o=n,n=r,r=e,e=t,t=null);var a=t&&_typeof(t)==="object";if(t=t||{},this.json=t.json||r,this.path=t.path||e,this.resultType=t.resultType||"value",this.flatten=t.flatten||!1,this.wrap=hasOwnProp.call(t,"wrap")?t.wrap:!0,this.sandbox=t.sandbox||{},this.preventEval=t.preventEval||!1,this.parent=t.parent||null,this.parentProperty=t.parentProperty||null,this.callback=t.callback||n||null,this.otherTypeCallback=t.otherTypeCallback||o||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},t.autostart!==!1){var s={path:a?t.path:e};a?"json"in t&&(s.json=t.json):s.json=r;var c=this.evaluate(s);if(!c||_typeof(c)!=="object")throw new NewError(c);return c}}JSONPath.prototype.evaluate=function(t,e,r,n){var o=this,a=this.parent,s=this.parentProperty,c=this.flatten,u=this.wrap;if(this.currResultType=this.resultType,this.currPreventEval=this.preventEval,this.currSandbox=this.sandbox,r=r||this.callback,this.currOtherTypeCallback=n||this.otherTypeCallback,e=e||this.json,t=t||this.path,t&&_typeof(t)==="object"&&!Array.isArray(t)){if(!t.path&&t.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!hasOwnProp.call(t,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');var l=t;e=l.json,c=hasOwnProp.call(t,"flatten")?t.flatten:c,this.currResultType=hasOwnProp.call(t,"resultType")?t.resultType:this.currResultType,this.currSandbox=hasOwnProp.call(t,"sandbox")?t.sandbox:this.currSandbox,u=hasOwnProp.call(t,"wrap")?t.wrap:u,this.currPreventEval=hasOwnProp.call(t,"preventEval")?t.preventEval:this.currPreventEval,r=hasOwnProp.call(t,"callback")?t.callback:r,this.currOtherTypeCallback=hasOwnProp.call(t,"otherTypeCallback")?t.otherTypeCallback:this.currOtherTypeCallback,a=hasOwnProp.call(t,"parent")?t.parent:a,s=hasOwnProp.call(t,"parentProperty")?t.parentProperty:s,t=t.path}if(a=a||null,s=s||null,Array.isArray(t)&&(t=JSONPath.toPathString(t)),!(!t&&t!==""||!e)){var i=JSONPath.toPathArray(t);i[0]==="$"&&i.length>1&&i.shift(),this._hasParentSelector=null;var p=this._trace(i,e,["$"],a,s,r).filter(function(f){return f&&!f.isParentSelector});return p.length?!u&&p.length===1&&!p[0].hasArrExpr?this._getPreferredOutput(p[0]):p.reduce(function(f,d){var y=o._getPreferredOutput(d);return c&&Array.isArray(y)?f=f.concat(y):f.push(y),f},[]):u?[]:void 0}},JSONPath.prototype._getPreferredOutput=function(t){var e=this.currResultType;switch(e){case"all":{var r=Array.isArray(t.path)?t.path:JSONPath.toPathArray(t.path);return t.pointer=JSONPath.toPointer(r),t.path=typeof t.path=="string"?t.path:JSONPath.toPathString(t.path),t}case"value":case"parent":case"parentProperty":return t[e];case"path":return JSONPath.toPathString(t[e]);case"pointer":return JSONPath.toPointer(t.path);default:throw new TypeError("Unknown result type")}},JSONPath.prototype._handleCallback=function(t,e,r){if(e){var n=this._getPreferredOutput(t);t.path=typeof t.path=="string"?t.path:JSONPath.toPathString(t.path),e(n,r,t)}},JSONPath.prototype._trace=function(t,e,r,n,o,a,s,c){var u=this,l;if(!t.length)return l={path:r,value:e,parent:n,parentProperty:o,hasArrExpr:s},this._handleCallback(l,a,"value"),l;var i=t[0],p=t.slice(1),f=[];function d(h){Array.isArray(h)?h.forEach(function(D){f.push(D)}):f.push(h)}if((typeof i!="string"||c)&&e&&hasOwnProp.call(e,i))d(this._trace(p,e[i],push(r,i),e,i,a,s));else if(i==="*")this._walk(e,function(h){d(u._trace(p,e[h],push(r,h),e,h,a,!0,!0))});else if(i==="..")d(this._trace(p,e,r,n,o,a,s)),this._walk(e,function(h){_typeof(e[h])==="object"&&d(u._trace(t.slice(),e[h],push(r,h),e,h,a,!0))});else{if(i==="^")return this._hasParentSelector=!0,{path:r.slice(0,-1),expr:p,isParentSelector:!0};if(i==="~")return l={path:push(r,i),value:o,parent:n,parentProperty:null},this._handleCallback(l,a,"property"),l;if(i==="$")d(this._trace(p,e,r,null,null,a,s));else if(/^(\x2D?[0-9]*):(\x2D?[0-9]*):?([0-9]*)$/.test(i))d(this._slice(i,p,e,r,n,o,a));else if(i.indexOf("?(")===0){if(this.currPreventEval)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");var y=i.replace(/^\?\(((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?)\)$/,"$1"),g=/@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])?((?:[\0->@-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)['\[](\??\((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\))(?!(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])\)\])['\]]/g.exec(y);g?this._walk(e,function(h){var D=[g[2]],M=g[1]?e[h][g[1]]:e[h],k=u._trace(D,M,r,n,o,a,!0);k.length>0&&d(u._trace(p,e[h],push(r,h),e,h,a,!0))}):this._walk(e,function(h){u._eval(y,e[h],h,r,n,o)&&d(u._trace(p,e[h],push(r,h),e,h,a,!0))})}else if(i[0]==="("){if(this.currPreventEval)throw new Error("Eval [(expr)] prevented in JSONPath expression.");d(this._trace(unshift(this._eval(i,e,r[r.length-1],r.slice(0,-1),n,o),p),e,r,n,o,a,s))}else if(i[0]==="@"){var w=!1,b=i.slice(1,-2);switch(b){case"scalar":(!e||!["object","function"].includes(_typeof(e)))&&(w=!0);break;case"boolean":case"string":case"undefined":case"function":_typeof(e)===b&&(w=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(w=!0);break;case"number":Number.isFinite(e)&&(w=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(w=!0);break;case"object":e&&_typeof(e)===b&&(w=!0);break;case"array":Array.isArray(e)&&(w=!0);break;case"other":w=this.currOtherTypeCallback(e,r,n,o);break;case"null":e===null&&(w=!0);break;default:throw new TypeError("Unknown value type "+b)}if(w)return l={path:r,value:e,parent:n,parentProperty:o},this._handleCallback(l,a,"value"),l}else if(i[0]==="`"&&e&&hasOwnProp.call(e,i.slice(1))){var R=i.slice(1);d(this._trace(p,e[R],push(r,R),e,R,a,s,!0))}else if(i.includes(",")){var T=i.split(","),O=_createForOfIteratorHelper(T),A;try{for(O.s();!(A=O.n()).done;){var _=A.value;d(this._trace(unshift(_,p),e,r,n,o,a,!0))}}catch(h){O.e(h)}finally{O.f()}}else!c&&e&&hasOwnProp.call(e,i)&&d(this._trace(p,e[i],push(r,i),e,i,a,s,!0))}if(this._hasParentSelector)for(var m=0;m<f.length;m++){var E=f[m];if(E&&E.isParentSelector){var S=this._trace(E.expr,e,E.path,n,o,a,s);if(Array.isArray(S)){f[m]=S[0];for(var I=S.length,C=1;C<I;C++)m++,f.splice(m,0,S[C])}else f[m]=S}}return f},JSONPath.prototype._walk=function(t,e){if(Array.isArray(t))for(var r=t.length,n=0;n<r;n++)e(n);else t&&_typeof(t)==="object"&&Object.keys(t).forEach(function(o){e(o)})},JSONPath.prototype._slice=function(t,e,r,n,o,a,s){if(Array.isArray(r)){var c=r.length,u=t.split(":"),l=u[2]&&Number.parseInt(u[2])||1,i=u[0]&&Number.parseInt(u[0])||0,p=u[1]&&Number.parseInt(u[1])||c;i=i<0?Math.max(0,i+c):Math.min(c,i),p=p<0?Math.max(0,p+c):Math.min(c,p);for(var f=[],d=i;d<p;d+=l){var y=this._trace(unshift(d,e),r,n,o,a,s,!0);y.forEach(function(g){f.push(g)})}return f}},JSONPath.prototype._eval=function(t,e,r,n,o,a){this.currSandbox._$_parentProperty=a,this.currSandbox._$_parent=o,this.currSandbox._$_property=r,this.currSandbox._$_root=this.json,this.currSandbox._$_v=e;var s=t.includes("@path");s&&(this.currSandbox._$_path=JSONPath.toPathString(n.concat([r])));var c="script:"+t;if(!JSONPath.cache[c]){var u=t.replace(/@parentProperty/g,"_$_parentProperty").replace(/@parent/g,"_$_parent").replace(/@property/g,"_$_property").replace(/@root/g,"_$_root").replace(/@([\t-\r \)\.\[\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])/g,"_$_v$1");s&&(u=u.replace(/@path/g,"_$_path")),JSONPath.cache[c]=new this.vm.Script(u)}try{return JSONPath.cache[c].runInNewContext(this.currSandbox)}catch(l){throw new Error("jsonPath: "+l.message+": "+t)}},JSONPath.cache={},JSONPath.toPathString=function(t){for(var e=t,r=e.length,n="$",o=1;o<r;o++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(e[o])||(n+=/^[\*0-9]+$/.test(e[o])?"["+e[o]+"]":"['"+e[o]+"']");return n},JSONPath.toPointer=function(t){for(var e=t,r=e.length,n="",o=1;o<r;o++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(e[o])||(n+="/"+e[o].toString().replace(/~/g,"~0").replace(/\//g,"~1"));return n},JSONPath.toPathArray=function(t){var e=JSONPath.cache;if(e[t])return e[t].concat();var r=[],n=t.replace(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/g,";$&;").replace(/['\[](\??\((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\))['\]](?!(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])\])/g,function(a,s){return"[#"+(r.push(s)-1)+"]"}).replace(/\[["']((?:[\0-&\(-\\\^-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)["']\]/g,function(a,s){return"['"+s.replace(/\./g,"%@%").replace(/~/g,"%%@@%%")+"']"}).replace(/~/g,";~;").replace(/["']?\.["']?(?!(?:[\0-Z\\-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*\])|\[["']?/g,";").replace(/%@%/g,".").replace(/%%@@%%/g,"~").replace(/(?:;)?(\^+)(?:;)?/g,function(a,s){return";"+s.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,""),o=n.split(";").map(function(a){var s=a.match(/#([0-9]+)/);return!s||!s[1]?a:r[s[1]]});return e[t]=o,e[t].concat()};var moveToAnotherArray=function(e,r,n){for(var o=e.length,a=0;a<o;a++){var s=e[a];n(s)&&r.push(e.splice(a--,1)[0])}},Script=function(){function t(e){_classCallCheck(this,t),this.code=e}return _createClass(t,[{key:"runInNewContext",value:function(r){var n=this.code,o=Object.keys(r),a=[];moveToAnotherArray(o,a,function(i){return typeof r[i]=="function"});var s=o.map(function(i){return r[i]}),c=a.reduce(function(i,p){var f=r[p].toString();return/function/.test(f)||(f="function "+f),"var "+p+"="+f+";"+i},"");n=c+n,!/(["'])use strict\1/.test(n)&&!o.includes("arguments")&&(n="var arguments = undefined;"+n),n=n.replace(/;[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*$/,"");var u=n.lastIndexOf(";"),l=u>-1?n.slice(0,u+1)+" return "+n.slice(u+1):" return "+n;return _construct(Function,o.concat([l])).apply(void 0,_toConsumableArray(s))}}]),t}();JSONPath.prototype.vm={Script};const EXTERNAL_OPERATION_TYPE={ADD_ITEMS:"cart.add-items/v1"};function shouldUpdateExternalResources(t){return Object.values(EXTERNAL_OPERATION_TYPE).includes(t)}const resourcesToUpdate={"[cart.count/v1].items":t=>{const e=window.top||window;e.P.when("nav.setCartCount").execute(function(r){r(t)}),e!==window&&window.P.when("nav.setCartCount").execute(function(r){r(t)})}};function updateResources(t){Object.entries(resourcesToUpdate).map(([e,r])=>{const n=JSONPath({path:"$.."+e,json:t});n.length==0?logFatal("Could not find "+e+" in response",new Error("Invalid response. Search Result returned empty")):r(n[0])})}class BatchAAPIOperationRxResponse extends WebFlowServerRxResponse{constructor(e){super(RxResponseType.RemoteAAPIBatchOperationResponse),this.payload=e}}class UnknownResponseError extends Error{constructor(e){super(RxResponseType.UnknownResponse),this.payload=e,this.type=RxResponseType.UnknownResponse}}class LayoutDiffingRxResponse extends WebFlowServerRxResponse{constructor(e){super(RxResponseType.LayoutDiffingResponse),this.payload=e}}class CardRerenderRxResponse extends WebFlowServerRxResponse{constructor(e){super(RxResponseType.CardRerenderResponse),this.payload=e}}function extractBoundary(t){const e=t.match(/boundary=([^;]+)/);if(!e)throw new Error("No boundary found in Content-Type header");let r=e[1].trim();return r.startsWith('"')&&r.endsWith('"')&&(r=r.slice(1,-1)),r}function parseHeaders(t){const e={},r=t.trim().split(`
`);for(const n of r){const o=n.indexOf(":");if(o>0){const a=n.substring(0,o).trim(),s=n.substring(o+1).trim();e[a]=s}}return e}function parsePart(t){const e=t.trim();if(!e)return null;const r=[`
\r
`,`\r
\r
`,`

`];for(const n of r){const o=e.indexOf(n);if(o!==-1){const a=e.substring(0,o),s=e.substring(o+n.length);return{headers:parseHeaders(a),body:s}}}return{headers:parseHeaders(e),body:""}}async function parseMultipartStream(t,e){var u;const r=t.headers.get("content-type");if(!r)throw new Error("Missing Content-Type header");const o=`--${extractBoundary(r)}`,a=(u=t.body)==null?void 0:u.getReader();if(!a)throw new Error("Response body is not readable");const s=new TextDecoder;let c="";try{for(;;){const{done:l,value:i}=await a.read();if(i){const f=s.decode(i,{stream:!0});c+=f}let p=c.indexOf(o);for(;p!==-1;){const f=p+o.length,d=c.indexOf(o,f);if(d===-1)break;let y=p+o.length;c[y]===`
`&&y++,c[y]==="\r"&&y++;const g=c.substring(y,d);c=c.substring(d),p=0;const b=c.substring(o.length,o.length+2)==="--";if(g.trim()){const R=parsePart(g);R&&await e(R)}if(b)return}if(l)break}}finally{a.releaseLock()}}const setExternalPatchReplaceTransitionState=Patch__namespace.setExternalPatchReplaceTransitionState??(()=>{warnToConsole("setExternalPatchReplaceTransitionState not yet implemented")}),clearExternalPatchReplaceTransitionState=Patch__namespace.clearExternalPatchReplaceTransitionState??(()=>{warnToConsole("clearExternalPatchReplaceTransitionState not yet implemented")});class LayoutDiffingManager{constructor(){}static getInstance(){return LayoutDiffingManager.instance||(LayoutDiffingManager.instance=new LayoutDiffingManager),LayoutDiffingManager.instance}processHtmlForPatching(htmlContent){const tempElement=document.createElement("div");tempElement.innerHTML=htmlContent;const scripts=tempElement.querySelectorAll("script");return scripts.forEach(script=>{var t;const content=(t=script.textContent)==null?void 0:t.trim();content&&eval(content),script.remove()}),tempElement.innerHTML}setCurrentRequest(t,e){this.currentFlowRoute=t,this.presentationConfig=e}getFlowRoute(){return this.currentFlowRoute}getPresentationConfig(){return this.presentationConfig}applyGrayout(){this.presentationConfig&&setExternalPatchReplaceTransitionState({allowedIds:this.presentationConfig.animationIdPrefixAllowList,disallowedIds:this.presentationConfig.animationIdPrefixDisallowList})}applyGrayoutToTarget(t){if(!this.presentationConfig)return;const e=document.createElement("div");e.innerHTML=t,setExternalPatchReplaceTransitionState({allowedIds:this.presentationConfig.animationIdPrefixAllowList,disallowedIds:this.presentationConfig.animationIdPrefixDisallowList,targetElement:e})}clearGrayout(){clearExternalPatchReplaceTransitionState()}clear(){this.currentFlowRoute=void 0,this.presentationConfig=void 0}}const patchReplaceOnExternalConfig=Patch__namespace.patchReplaceOnExternalConfig??(()=>{warnToConsole("patchReplaceOnExternalConfig not yet implemented")});class WebFlowServerRxResponseHandler{updateBrowserUrl(e){if(!(e!=null&&e.flow.inputs))return;const r=new URL(window.location.href);let n=!1,o=!1;if(e.flow.inputs.asin&&e.flow.inputs.asin!=="placeholder"){const l=String(e.flow.inputs.asin);if(r.pathname.includes("/product/")){if(/\/product\/[A-Z0-9]{10}/.test(r.pathname)){const p=r.pathname;r.pathname=r.pathname.replace(/\/product\/[A-Z0-9]{10}/,`/product/${l}`),p!==r.pathname&&(n=!0,o=!0)}}else if(r.pathname.includes("/dp/")&&/\/dp\/[A-Z0-9]{10}\//.test(r.pathname)){const p=r.pathname;r.pathname=r.pathname.replace(/\/dp\/[A-Z0-9]{10}\//,`/dp/${l}/`),p!==r.pathname&&(n=!0,o=!0)}}const a=new URLSearchParams,s=new URLSearchParams(r.search);s.forEach((l,i)=>{urlParameterKeys.some(p=>p.toLowerCase()===i.toLowerCase())&&a.set(i,l)}),Object.entries(e.flow.inputs).forEach(([l,i])=>{if(i!=="placeholder"){const f=typeof i=="object"&&i!==null?JSON.stringify(i):String(i);if(l==="asin"){if(o){s.has("asin")&&a.set(l,f);return}a.set(l,f);return}a.set(l,f)}});const c=a.toString(),u=r.searchParams.toString();c!==u&&(r.search=c,n=!0),n&&window.history.replaceState(null,"",r.href)}async handleRxResponse(e){if(e.ok)return this.convertToRxResponse(e);{const r=new Error("Response is not ok");throw logFatal("Fetch call returned "+e.status+": "+r.message,r),new UnknownResponseError(this.handleUnknownResponse(e))}}async convertToRxResponse(e){var r;try{if((r=e.headers.get("content-type"))!=null&&r.includes("multipart/mixed")){const n=e.headers.get("content-type"),o=n==null?void 0:n.match(/type=([^;]+)/),a=o?o[1]:null;return a==="card-rerender"?this.handleCardRerenderResponse(e):a==="layout-diffing"?this.handleLayoutDiffingResponse(e):this.handleLayoutDiffingResponse(e)}else{const n=await e.text(),o=JSON.parse(n);switch(o.type){case RxResponseType.ViewPublisherResponse:return this.handleViewPublisherResponse(o);case RxResponseType.RemoteViewModelMapperExecutionResponse:return this.handleRemoteViewModelMapperResponse(o);case RxResponseType.RemoteAAPIBatchOperationResponse:return this.handleRemoteBatchAAPIOperationsRxResponse(this.parseBatchAAPIOperationRxResponse(o));case RxResponseType.UnknownResponse:default:return this.handleUnknownResponse(e)}}}catch(n){return logFatal("Something went wrong in WebFlowServerRxResponseHandler: "+n.message,n),this.handleUnknownResponse(e)}}parseBatchAAPIOperationRxResponse(e){return new BatchAAPIOperationRxResponse(e.payload)}handleViewPublisherResponse(e){return e.payload.statusCode==200&&updateResources(e.payload.untypedResponseBody),e}handleRemoteViewModelMapperResponse(e){return e.payload.statusCode==200&&updateResources(e.payload.untypedResponseBody),e}handleRemoteBatchAAPIOperationsRxResponse(e){for(const r of e.payload.aapiOperationResponses)if(r.payload.statusCode===200){const{type:n,untypedResponseBody:o}=r.payload;shouldUpdateExternalResources(n)&&updateResources(o)}return e}async handleCardRerenderResponse(e){const r=e.status;return r!==200?new CardRerenderRxResponse({status:"error",message:`Card rerender returned non-200 status code: ${r}`,statusCode:r,response:e}):(logToConsole("WebFlowJS: Card rerender returned 200 status code"),new CardRerenderRxResponse({status:"success",message:"Card rerender returned 200 status code",statusCode:200,response:e}))}async handleLayoutDiffingResponse(e){const r=e.status;if(r!==200)return new LayoutDiffingRxResponse({status:"error",message:`Server returned non-200 status code: ${r}`,statusCode:r});const n=LayoutDiffingManager.getInstance();try{await parseMultipartStream(e,a=>{if(a.headers.Type==="diffing.node.diff/v1"){const s=n.processHtmlForPatching(a.body);return n.applyGrayoutToTarget(s),patchReplaceOnExternalConfig(a.headers.referenceId,s)}a.headers.Type==="diffing.node.delete/v1"&&StateManager.getInstance().deleteNodeState(a.headers.referenceId),a.headers.Type==="rxCount/v1"&&ViewModelMapperTracker.getInstance().setExpectedCount(parseInt(a.body))});const o=n.getFlowRoute();return o&&this.updateBrowserUrl(o),new LayoutDiffingRxResponse({status:"success",message:"Layout diffing completed successfully",statusCode:r})}catch(o){const a=o instanceof Error?o.message:String(o);return logFatal("WebFlowJS: Failed to process layout diffing:"+o.message,o),new LayoutDiffingRxResponse({status:"error",message:`Failed to process layout diffing: ${a}`,statusCode:r})}}async processReentrantRenderResponse(e,r,n){var o,a,s;if(e&&typeof e=="object"&&"type"in e&&e.type===RxResponseType.CardRerenderResponse){const c=e;if((o=c.payload)!=null&&o.response){const u=c.payload.response;if((s=(a=u.headers)==null?void 0:a.get("content-type"))!=null&&s.includes("multipart/mixed")){if(logToConsole("WebFlowJS: Processing multipart reentrant response"),!r.patchReplace||typeof r.patchReplace!="function")throw new Error(`patchReplace method not available for externalComposedKey: ${n}`);return await parseMultipartStream(u,async l=>{l.headers.Type==="rendered-card/v1"&&(await r.patchReplace(l.body),logToConsole("WebFlowJS: Successfully patched HTML for reentrant rendering:",n))}),!0}}}return!1}handleUnknownResponse(e){return new UnknownRxResponse(e)}}class RxRequestHandler{buildRemoteViewModelMapperRequestV1(e,r){return{method:"POST",requestType:"RemoteViewModelMapperExecution",schemaVersion:"V1",bundleUri:e.bundleUri,payload:{viewModelMapperLocator:e,variableTable:r.serialize()}}}buildRemoteBatchAAPIOperation(e){return{method:"POST",requestType:"RemoteBatchAAPIOperation",schemaVersion:"2",payload:e}}buildBlueprintDiffRequest(e,r){return{method:"POST",requestType:"LayoutDiffingRequest",schemaVersion:"1",payload:{previousRenderStates:e},flowRoute:r}}handleRequest(e,r){return logToConsole("payload: ",r),this.buildRxRequestBody(e,r)}buildRxRequestBody(e,r){return{resourcePath:internalDataStoredValues.resourcePath,responseType:internalDataStoredValues.responseType,method:internalDataStoredValues.method,bundleUri:e,payload:r}}buildReentrantRenderRequest(e,r,n){const{externalComposedKey:o,viewModelMapperUuid:a,metadata:{bundleUri:s="",initialViewModel:c={},inputModel:u={},aapiResourceReferences:l="",templateAssets:i={}}={}}=e,p=(()=>{try{return JSON.parse(l)}catch{return warnToConsole("Failed to parse aapiResourceReferences json:",l),{}}})(),f=o.split("/"),d=f.length>5?f[5]:"";return{method:"POST",requestType:"CardRerender",schemaVersion:"1",bundleUri:s,flowRoute:{flow:{experienceId:d,inputs:{}}},payload:{rerenderInstructions:[{referenceId:o,bundleUri:s,viewModelMapperUuid:a,initialViewModel:c,inputModel:u,kataData:n,aapiResourceReferences:p,reentrantVars:r,templateAssets:i}]}}}}const TIMESTAMP_FLAGS={bodyEnd:"be",bodyBegin:"bb",timeOfClick:"tc"},LOAD_DONE_MARKER="ld",WIDGET_BASED_SCOPE={wb:1},startTimer=t=>{logToConsole(`Start timer for latency metric: ${t}`),window.uet&&window.uet(TIMESTAMP_FLAGS.timeOfClick,t,WIDGET_BASED_SCOPE)},endTimer=t=>{logToConsole(`End timer: ${t}`),window.uex&&window.uex(LOAD_DONE_MARKER,t,WIDGET_BASED_SCOPE)},_WebFlowJS=class x{constructor(){this.webflowClient=new WebFlowClient,this.rxRequestHandler=new RxRequestHandler,this.webflowServerRxResponseHandler=new WebFlowServerRxResponseHandler}static getInstance(){return x.instance||(x.instance=new x),x.instance}async executeRxRequest(e){const r=performance.now();try{const n=await this.webflowClient.callbackToWebFlowServer(e);return await this.webflowServerRxResponseHandler.handleRxResponse(n)}catch(n){return logError("Failed to execute RxRequest - "+e,n),n.payload}finally{const o=performance.now()-r;logToConsole(`WebFlow RxRequestTime: ${o.toFixed(2)}ms`)}}async renderExperience(e,r){const n=this.rxRequestHandler.handleRequest(e,r);return this.executeRxRequest(n)}async executeRemoteViewModelMapper(e,r){const n=this.rxRequestHandler.buildRemoteViewModelMapperRequestV1(e,r);return this.executeRxRequest(n)}async executeRemoteBatchAAPIOperation(e){const r=this.rxRequestHandler.buildRemoteBatchAAPIOperation(e);return this.executeRxRequest(r)}async executeBlueprintDiffing(e,r){const n=e.flow.experienceId,o=n?`webflow-layout-diffing-${n}`:"webflow-layout-diffing",a=LayoutDiffingManager.getInstance();a.setCurrentRequest(e,r),startTimer(o);try{a.applyGrayout(),ViewModelMapperTracker.getInstance().resetRenderComplete();const s=StateManager.getInstance().getNodeStates(),c=this.rxRequestHandler.buildBlueprintDiffRequest(s,e);logToConsole("WebFlowJS: Executing blueprint diffing request:",c);const u=await this.executeRxRequest(c);return endTimer(o),u}catch(s){throw endTimer(o),s}finally{a.clearGrayout(),a.clear()}}getExperienceState(){return{callbackId:internalDataStoredValues.callbackId}}async executeReentrantRender(e,r,n){try{const{externalComposedKey:o,viewModelMapperUuid:a,metadata:{bundleUri:s="",initialViewModel:c={},inputModel:u={},aapiResourceReferences:l={},templateAssets:i={},...p}={}}=e;if(logToConsole("WebFlowJS: Extracted event data:",{externalComposedKey:o,viewModelMapperUuid:a,bundleUri:s,initialViewModel:c,inputModel:u,aapiResourceReferences:l,templateAssets:i,otherMetadata:p}),!r)throw new Error(`No external control provided for externalComposedKey: ${o}`);if(!r.captureVars||typeof r.captureVars!="function")throw new Error(`captureVars method not available for externalComposedKey: ${o}`);const f=await r.captureVars();logToConsole("WebFlowJS: Captured reentrant vars for",o,":",f);const d=this.rxRequestHandler.buildReentrantRenderRequest(e,f,n);logToConsole("WebFlowJS: Executing enhanced reentrant rendering request:",d);const y=await this.executeRxRequest(d);if(await this.webflowServerRxResponseHandler.processReentrantRenderResponse(y,r,o))return;throw new Error(`WebFlowJS: Reentrant Render response (non-multipart) for externalComposedKey: ${o}`)}catch(o){throw logError("WebFlowJS: Reentrant rendering failed for "+((e==null?void 0:e.externalComposedKey)||"unknown"),o),o}}register(){invokeKWFExternalConfig(this.renderExperience.bind(this),this.executeReentrantRender.bind(this))}};_WebFlowJS.instance=null;let WebFlowJS=_WebFlowJS;var AAPIOperationErrorTypes=(t=>(t.WebFlowServerError="Internal WebFlow Server Error",t.ExperienceModelError="Unexpected Input received from the experience model",t))(AAPIOperationErrorTypes||{});class AAPIResourceManager{static async post(e,...r){const n=[e,...r].map(a=>({...a,resourcePath:this.resolveResourcePath(a.resourcePath,a.params,a.requestArguments),method:"POST"})),o=await WebFlowJS.getInstance().executeRemoteBatchAAPIOperation({payload:n});return o instanceof BatchAAPIOperationRxResponse?this.unpackPostResponse(o,n[0]):this.ofFailedOperation(n[0],"Received unexpected response type from the server.",AAPIOperationErrorTypes.WebFlowServerError)}static unpackPostResponse(e,r){if(e.payload.statusCode==500)return this.ofFailedOperation(r,"The BatchAAPIOperationRequest failed.",AAPIOperationErrorTypes.WebFlowServerError);const n=e.payload.aapiOperationResponses[0];return n?n.payload.statusCode==500?this.ofFailedOperation(r,n.payload.untypedError,n.payload.type):this.proxyResultWithOverloadedGetOperator({isSuccess:!0,resource:n.payload.untypedResponseBody,type:n.payload.type}):this.ofFailedOperation(r,`No AAPI response was returned for this operation: ${JSON.stringify(r)}`,AAPIOperationErrorTypes.WebFlowServerError)}static get(e,r){if(e.payload)return this.ofFailedOperation(e,"GET AAPIOperation does not accept a payload.",AAPIOperationErrorTypes.ExperienceModelError);const n=this.resolveResourcePath(e.resourcePath,e.params,e.requestArguments);if(r){const s=this.stateManager.getStateByVmmId(StateChannel.AmazonApi,r,n);if(s&&!this.isResourceError(s==null?void 0:s.entity)){const c=s==null?void 0:s.entity[e.responseType];if(c)return this.proxyResultWithOverloadedGetOperator({isSuccess:!0,resource:c,type:e.responseType})}}const o=this.stateManager.getState(StateChannel.AmazonApi,n);if(this.isResourceError(o==null?void 0:o.entity))return this.remoteGetRequest(e);const a=o==null?void 0:o.entity[e.responseType];return a?this.proxyResultWithOverloadedGetOperator({isSuccess:!0,resource:a,type:e.responseType}):this.remoteGetRequest(e)}static async remoteGetRequest(e){const r=await WebFlowJS.getInstance().executeRemoteBatchAAPIOperation({payload:[e]});return r instanceof BatchAAPIOperationRxResponse?this.unpackPostResponse(r,e):this.ofFailedOperation(e,"Received unexpected response type from the server.",AAPIOperationErrorTypes.WebFlowServerError)}static ofFailedOperation(e,r,n){const o=new Error(`AAPI resource operation failed. Operation=${JSON.stringify(e)}. Detailed Message=${r}`);return this.proxyResultWithOverloadedGetOperator({isSuccess:!1,error:o,type:n})}static isResourceError(e){return e&&"errorPayload"in e}static resolveResourcePath(e,r,n){if(r&&Object.keys(r).forEach(o=>{e=e.replace(`${o}`,r[o])}),e.includes("?")&&!n){const[o,a]=e.split("?");if(a){const c=a.split("&").sort().join("&");e=`${o}?${c}`}}return n&&(e+="?",Object.keys(n).sort().forEach(a=>{e+=`${a}=${n[a]}&`}),e=e.substring(0,e.length-1)),e}static proxyResultWithOverloadedGetOperator(e){const r={get(n,o){return n.resource&&n.resource[o]!==void 0?n.resource[o]:Reflect.get(n,o)}};return new Proxy(e,r)}}AAPIResourceManager.stateManager=StateManager.getInstance();function buildAssemblerContext(){let t=window.location.href;return t||(logError("ingressUrl not presented"),t=""),{ingressUrl:t}}const assemblerContext=buildAssemblerContext(),getAssemblerContext=()=>assemblerContext;function getQueryStringFromContext(){const t=getAssemblerContext().ingressUrl;if(!t)return"";try{return new URL(t).search??""}catch{return""}}const addToCart=({request:t,queryString:e})=>{logToConsole(`addToCart: request = ${t} - queryString = ${e}`);const n={resourcePath:`/api/marketplaces/:marketplace-id/cart/carts/retail/items${e?`?${e}`:getQueryStringFromContext()}`,requestType:"cart.add-items.request/v1",responseType:"cart.add-items/v1",payload:t,method:"POST"};return webflowRx.from(AAPIResourceManager.post(n))},AvroUnionKeys=new Set(["null","boolean","int","long","float","double","bytes","string","record","enum","array","map","fixed"]),csaInteractionSchema="csa.ContentInteraction.2",dawnInteractionSchema="dawnSearch.DawnContentInteractions.4",logClientSideAnalyticsEvent=t=>{const e={...removeAvroFormattingFromNexusEventData(t.data),lob:"1"};return logCsaEventUsingWebPlugin(t.producerId,{schemaId:t.schemaId,...e,customerId:getCustomerId()},{ent:{page:["pageType","subPageType","requestId"],element:!0}}),t.schemaId===dawnInteractionSchema&&(logToConsole(`[logClientSideAnalyticsEvent] Dual-publishing ${dawnInteractionSchema} event to ${csaInteractionSchema}`),logCsaEventUsingWebPlugin(t.producerId,{schemaId:csaInteractionSchema,...e},{ent:{page:["pageType","subPageType"],element:!0}})),webflowRx.EMPTY};function getCustomerId(){var t,e,r,n,o;return((t=window.opts)==null?void 0:t.customerId)??((o=(n=(r=(e=window.$Nav)==null?void 0:e.getNow)==null?void 0:r.call(e,"config"))==null?void 0:n.searchISS)==null?void 0:o.customerId)??""}function logCsaEventUsingWebPlugin(t,e,r){var o;const n=(o=window==null?void 0:window.csa)==null?void 0:o.call(window,"Events",{producerId:t});if(!n){logToConsole("[logClientSideAnalyticsEvent] CSA API not available, unable to log event.");return}logToConsole(`[logClientSideAnalyticsEvent] Logging event to CSA:
event = ${JSON.stringify(e,null,4)}
option = ${JSON.stringify(r,null,4)}`),n("log",e,r)}function removeAvroFormattingFromNexusEventData(t){const e={};for(const[r,n]of Object.entries(t))e[r]=removeAvroFormattingFromNexusDataType(n);return e}function removeAvroFormattingFromNexusDataType(t){if(t==null)return t;if(Array.isArray(t))return t.map(removeAvroFormattingFromNexusDataType);if(typeof t=="object"){const e=Object.keys(t);return e.length===1&&AvroUnionKeys.has(e[0])?removeAvroFormattingFromNexusDataType(t[e[0]]):removeAvroFormattingFromNexusEventData(t)}return t}const stringify=({objectToStringify:t})=>{try{return JSON.stringify(t)}catch(e){throw new Error(`Serialization failed: ${e}`)}},log=({stringToLog:t})=>{logToConsole("[FlowLog]: "+t)},reactiveViewSubjectRegistry=new Map,auiListenerRegistry=new Set;function getOrCreateReactiveViewSubject(t,e){reactiveViewSubjectRegistry.has(e)||reactiveViewSubjectRegistry.set(e,new Map);const r=reactiveViewSubjectRegistry.get(e);if(!r.has(t)){const n=new webflowRx.Subject,o=n.next.bind(n);n.next=l=>{o(l);try{P.when("A").execute(i=>{i&&i.trigger&&i.trigger("flowReactiveViewSubject:"+t,l)})}catch(i){logError("Failed to execute P.now(A).execute() for subject: "+t,i)}};const a=n.asObservable();a.asReactiveViewValue=()=>webflowRx.ofReactiveViewValue(n.asObservable());const s=`flowReactiveViewSubject:${t}`;if(!auiListenerRegistry.has(s))try{P.when("A").execute(l=>{l&&l.on&&(l.on(s,i=>{o(i)}),auiListenerRegistry.add(s),l.trigger&&l.trigger(`flow-icc-ready:${t}`,t))})}catch(l){logError("Failed to set up AUI event listener for subject: "+t,l)}const c=webflowRx.ofReactiveViewPublisher(n),u={value:a,publisher:c};r.set(t,u)}return r.get(t)}const bindReactiveViewSubject=({id:t,webFlowRequestId:e})=>getOrCreateReactiveViewSubject(t,e),show=({route:t,presentationConfig:e})=>{WebFlowJS.getInstance().executeBlueprintDiffing(t,e)};class FunctionRegistry{constructor(){this.invokeFunction=(e,r)=>e in this.functions?this.functions[e](r):(console.warn(`No implementation defined for ${e}! Skipping execution.`),webflowRx.EMPTY),this.functions={showUpdatableToast,showPriceInfo,addToCart,addToCartTemp:addToCart,logClientSideAnalyticsEvent,stringify,log,bindReactiveViewSubject,flowExperienceRenderComplete,show}}registerFunction(e,r){this.functions[e]=r}}const functionRegistry=new FunctionRegistry;function executeRemoteViewModelMapper(t,e){return webflowRx.from(WebFlowJS.getInstance().executeRemoteViewModelMapper(t,e))}const webflowJs=WebFlowJS.getInstance();webflowJs.register();const executeBlueprintDiffing=webflowJs.executeBlueprintDiffing.bind(webflowJs);exports.AAPIResourceManager=AAPIResourceManager,exports.executeBlueprintDiffing=executeBlueprintDiffing,exports.executePortableFunction=executePortableFunction,exports.executeRemoteViewModelMapper=executeRemoteViewModelMapper,exports.functionRegistry=functionRegistry,exports.registerPortableFunction=registerPortableFunction,Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"})});
